# Base wall agent configuration with shared settings

# Session memory management for context efficiency.
# Trims old conversation turns by removing images and optionally summarizing text.
session_memory:
  enabled: true
  # Number of recent turns to keep fully intact (with images). N=2 means two completed
  # turns are kept and the current turn is also kept.
  keep_last_n_turns: 1
  # Summarize older turns via LLM (if false, just strip images).
  enable_summarization: true
  # Model for summarization ("agent" uses cfg.openai.model).
  summarization_model: "gpt-5.2"
  # Thinking effort for summarization ("none", "low", "medium", "high").
  summarization_thinking: "low"
  # Intra-turn observation stripping: strip images from older observe_scene outputs
  # within the current turn while keeping the last N observations with images intact.
  intra_turn_observation_stripping:
    enabled: true
    # Number of recent observe_scene outputs to keep with images.
    # Default 2 allows comparison between current and previous state.
    keep_last_n_observations: 2

# Rendering configuration.
rendering:
  # Top-down context view dimensions.
  top_view_width: 512
  top_view_height: 512

  # Side views (required by rendering_manager).
  side_view_count: 0
  side_view_width: 512
  side_view_height: 512

  # Grid overlay for wall coordinate reference.
  grid_divisions: 5

  # Distance threshold for showing furniture in wall views (meters).
  # Furniture within this distance from wall is shown in per-wall views.
  wall_furniture_threshold_m: 0.5

  background_color: [1.0, 1.0, 1.0]
  blender_server_host: "127.0.0.1"
  blender_server_port_range: [8000, 8250]
  retry_count: 10
  retry_delay: 3
  server_startup_delay: 0.1
  port_cleanup_delay: 0.1

  # Overlay annotations configuration.
  annotations:
    enable_set_of_mark_labels: true
    enable_bounding_boxes: true
    # Wall objects face into room, direction arrows not useful.
    enable_direction_arrows: false
    enable_partial_walls: true
    enable_support_surface_debug: false
    enable_convex_hull_debug: false
    # Grid overlay on wall orthographic views.
    enable_wall_grid: true

# Asset manager configuration
asset_manager:
  general_asset_source: "generated"
  backend: "sam3d"

  router:
    enabled: true
    parallel_workers: 10
    # Max retries for VLM analysis if parsing fails (e.g., invalid object_type)
    analysis_max_retries: 3
    strategies:
      generated:
        enabled: true
        max_retries: 2
      articulated:
        enabled: true
        max_retries: 3
        use_lenient_validation: true
      # Thin covering: textured flat surfaces (e.g., wall posters).
      thin_covering:
        enabled: true
        max_retries: 1
        thickness_m: 0.01
        texture_scale: 0.5  # Meters per tile for retrieved library textures (tileable)
        generator:
          enabled: true  # AI generation for custom artwork (posters, paintings, wall art)
          backend: "openai"
          max_retries: 3
          default_roughness: 128
          texture_scale: 0.5

  sam3d:
    sam3_checkpoint: "external/checkpoints/sam3.pt"
    sam3d_checkpoint: "external/checkpoints/pipeline.yaml"
    mode: "foreground"
    threshold: 0.5

  hssd:
    data_path: "data/hssd-models"
    preprocessed_path: "data/preprocessed"
    use_top_k: 5
    use_lenient_validation: true  # Use lenient validation for retrieved assets
    object_type_mapping:
      FURNITURE: "large_objects"
      MANIPULAND: "small_objects"
      WALL_MOUNTED: "wall_objects"
      CEILING_MOUNTED: "ceiling_objects"

  objaverse:
    data_path: "data/objathor-assets"
    preprocessed_path: "data/objathor-assets/preprocessed"
    use_top_k: 5
    use_lenient_validation: true  # Use lenient validation for retrieved assets
    object_type_mapping:
      FURNITURE: "large_objects"
      MANIPULAND: "small_objects"
      WALL_MOUNTED: "wall_objects"
      CEILING_MOUNTED: "ceiling_objects"

  articulated:
    enable_self_collision_filtering: true
    use_top_k: 5
    sources:
      partnet_mobility:
        enabled: false
        data_path: "data/partnet_mobility_sdf"
        embeddings_path: "data/partnet_mobility_sdf/embeddings"
      artvip:
        enabled: true
        data_path: "data/artvip_sdf"
        embeddings_path: "data/artvip_sdf/embeddings"

  image_generation:
    backend: "openai"
    openai:
      quality: "low"
    gemini:
      aspect_ratio: "1:1"
      image_size: "1K"
  num_side_views_for_physics_analysis: 4
  side_view_elevation_degrees: 0.0
  floater_distance_threshold: 0.05
  min_mesh_dimension_meters: 0.001
  # Wall objects (frames, prints) are legitimately thin - allow 0.5% ratio.
  mesh_relative_dimension_threshold: 0.005
  # EEVEE TAA samples for asset validation renders (mesh analysis, router validation).
  # Higher values = better quality but slower. Default 8 is a good balance.
  validation_taa_samples: 8

# Collision geometry configuration.
collision_geometry:
  # Decomposition method: "coacd" or "vhacd"
  method: "vhacd"

  server_port_range: [7100, 7350]

  # CoACD parameters (used when method="coacd")
  coacd:
    threshold: 0.03
    max_convex_hull: -1
    preprocess_mode: "auto"
    preprocess_resolution: 50
    resolution: 2000
    mcts_nodes: 20
    mcts_iterations: 150
    mcts_max_depth: 3
    pca: false
    merge: true
    decimate: false
    max_ch_vertex: 256
    extrude: false
    extrude_margin: 0.01
    apx_mode: "ch"
    seed: 0

  # V-HACD parameters (used when method="vhacd")
  vhacd:
    max_convex_hulls: 64
    resolution: 400000
    max_recursion_depth: 10
    max_num_vertices_per_ch: 64
    min_volume_percent_error: 1.0
    shrink_wrap: true
    fill_mode: "flood"
    min_edge_length: 2
    find_best_plane: false

# Maximum number of agent turns before stopping.
max_turns: 1000

# Maximum number of critique-and-improve rounds before stopping.
max_critique_rounds: 1

# Scene reset thresholds for detecting quality degradation.
reset_single_category_threshold: 2
reset_total_sum_threshold: 1

# Early finish threshold - stop if ALL categories score >= this value.
early_finish_min_score: 7

# OpenAI model and reasoning configuration.
openai:
  model: "gpt-5.2"
  service_tier: ${openai.service_tier}
  vision_detail: "high"
  reasoning_effort:
    planner: "low"
    designer: "high"
    critic: "high"
    mesh_analysis: "medium"
    asset_analysis: "medium"
    asset_validation: "medium"
  verbosity:
    planner: "medium"
    designer: "low"
    critic: "medium"
    mesh_analysis: "medium"
    asset_analysis: "medium"
    asset_validation: "medium"

# OpenAI API timeout configuration (seconds).
api_timeout:
  connect: 10.0
  read: 1800
  write: 1800
  pool: 1800

# Loop detection configuration for function tools.
loop_detection:
  enabled: true
  max_repeated_attempts: 25
  tracking_window: 30

# Physics validation configuration.
physics_validation:
  wall_thickness: 0.05
  floor_penetration_tolerance_m: 0.05
  object_penetration_threshold_m: 0.001
  manipuland_furniture_tolerance_m: 0.02

# Clearance zone configuration for open connections.
# Note: door_clearance_distance and window_clearance_distance are configured in
# floor_plan_agent config and baked into opening data during floor plan generation.
clearance_zones:
  # Axis-aligned square size for open connection passability (2D floor check).
  passage_size: 0.5
  # Meters of clearance for approaching open connections.
  open_connection_clearance: 0.7

# Wall-specific placement noise (wall axes: along wall, height).
placement_noise:
  mode: "auto"
  natural_profile:
    position_along_wall_std_meters: 0.02
    position_height_std_meters: 0.01
    rotation_std_degrees: 0.5
  perfect_profile:
    position_along_wall_std_meters: 0.001
    position_height_std_meters: 0.001
    rotation_std_degrees: 0.1
